from loader import dp, bot

from aiogram.dispatcher.storage import FSMContext
from aiogram.dispatcher.filters import Text
from aiogram.types import CallbackQuery, ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup

from states import Ivent
from sql import User, IventItem


@dp.callback_query_handler(state=Ivent.networking)
async def start(c: CallbackQuery, state: FSMContext):
    try:

        data = await state.get_data()
        await state.update_data({'user': data['user']+1})
        data = await state.get_data()

        users = [el.users for el in IventItem.select().where(IventItem.place == c.data)]

        user_list = []

        for user in users:
            try:
                if int(user.tg_id) != int(c.from_user.id) and int(user.age) > 0:
                    user_list.append(User.get(User.tg_id == user))
            except:
                pass

        user = user_list[data['user']]
        –°–±–∏–≤–∞–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –±–æ—Ç–∞, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ä—É—á–Ω—É—é,  –Ω–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
–ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∞ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—Ç–æ –∏–¥–µ—Ç 
–ß–∞—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–Ω–æ–ø–∫–∏ 
–ù–µ –¥–∞–µ—Ç –≤—ã–±—Ä–∞—Ç—å "–Ø –ø–æ–π–¥—É" –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
–£–±—Ä–∞—Ç—å –≤–µ—Å –∏ —Ä–æ—Å—Ç, –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—É (–º—É–∂—á–∏–Ω–∞/–∂–µ–Ω—à–∏–Ω–∞)
–ü–æ—Å—Ç–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å –Ω–∞ –≤–æ–∑—Ä–∞—Å—Ç —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø–æ–ª–Ω—è–ª–∏ –Ω–∞ –æ—Ç—ä–µ–±–∏—Å—å 
–ü—Ä–∏  –∑–∞—è–≤–∫–µ –Ω–∞ –Ω–µ—Ç–≤—Ä–æ–∫–∏–Ω–≥ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É–±—Ä–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –ø–∏—à–µ–º –Ω–∏–∫ tg print(user_list, data['user'])
        info = f'#{user.tg_id}\n'
        info += f"–ò–º—è: {user.name} \n"
        info += f"–í–æ–∑—Ä–∞—Å—Ç: {user.age} \n"
        info += f"–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: {user.profession} \n"
        info += f"–ò–Ω—Ç–µ—Ä–µ—Å—ã: {user.field_activity} \n"
        info += f"–†–æ—Å—Ç: {user.length} \n"
        info += f"–í–µ—Å: {user.weight} \n"

        result_kb = InlineKeyboardMarkup(row_width=2).add(
            InlineKeyboardButton(text='üëç –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ', callback_data='like')).add(
            InlineKeyboardButton(text='‚û°Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë', callback_data=f'{c.data}')).add(
            InlineKeyboardButton(text='–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', callback_data='main_menu'))

        try:
            await c.message.answer(text='clear kb', reply_markup=ReplyKeyboardMarkup([
                [KeyboardButton('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é')]
            ], resize_keyboard=True))
            await bot.delete_message(chat_id=c.from_user.id, message_id=c.message.message_id + 1)
            await bot.send_photo(chat_id=c.from_user.id, photo=user.photo, caption=info, reply_markup=result_kb)
        except:
            await c.message.answer(text=info, reply_markup=result_kb)
        await Ivent.networking.set()

    except Exception as e:
        print(e)
